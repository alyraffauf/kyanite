---
name: Validate Brewfiles
permissions:
    contents: read

on:
    pull_request:
        paths:
            - "brew/**/*.Brewfile"

jobs:
    validate:
        name: Validate Brewfiles
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Set Up Homebrew
              uses: Homebrew/actions/setup-homebrew@65516a4ce48497d7703861a3013abaa1c16b3956 # master

            - name: Validate Brewfiles
              run: |
                  echo "Validating Brewfiles in brew/ directory..."
                  echo ""

                  set -euo pipefail

                  find "brew" -type f -iname '*.Brewfile' -print0 | \
                    while IFS= read -r -d '' brewfile; do
                      echo "::group::Validating $(basename "${brewfile}")"
                      grep -E -e "^tap" "${brewfile}" > taps.Brewfile || echo "# No taps" > taps.Brewfile
                      set -x
                      brew bundle --file=./taps.Brewfile
                      if brew bundle exec whoami --file="${brewfile}" | grep -F -e "${USER}"; then
                        set +x
                        echo "✓ $(basename "${brewfile}") passed validation"
                      else
                        set +x
                        echo "✗ $(basename "${brewfile}") validation failed"
                        exit 1
                      fi
                      echo "::endgroup::"
                    done

                  echo ""
                  echo "All Brewfiles validated successfully"
