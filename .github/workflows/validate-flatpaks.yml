---
name: Validate Flatpaks
permissions:
    contents: read

on:
    pull_request:
        paths:
            - "flatpaks/**"

jobs:
    validate:
        name: Validate Flatpaks
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Set Up Flathub
              run: |
                  echo "Setting up Flatpak and Flathub repository..."
                  sudo apt-get update
                  sudo apt-get install -y flatpak
                  flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
                  echo "✓ Flathub repository configured"

            - name: Validate Flatpaks
              run: |
                  echo "Validating Flatpak files in flatpaks/ directory..."
                  echo ""

                  set -euo pipefail

                  find "flatpaks" -iname '*.preinstall' -print0 | \
                    while IFS= read -r -d '' flatpaks_file; do
                      echo "::group::Validating $(basename "${flatpaks_file}")"
                      # Extract Flatpak IDs from [Flatpak Preinstall NAME] sections
                      grep -E '^\[Flatpak Preinstall ' "${flatpaks_file}" | \
                        sed 's/\[Flatpak Preinstall \(.*\)\]/\1/' | \
                        while read -r flatpak; do
                          echo "Checking ${flatpak}..."
                          flatpak remote-info --user flathub "${flatpak}"
                        done
                      echo "✓ $(basename "${flatpaks_file}") passed validation"
                      echo "::endgroup::"
                    done

                  echo ""
                  echo "All Flatpak files validated successfully"
