---
name: Build Image
on:
    workflow_call:
        inputs:
            image_name:
                description: "Name of the image to build"
                required: true
                type: string
            image_flavor:
                description: "Image flavor (main or gaming)"
                required: true
                type: string
            image_desc:
                description: "Image description"
                required: true
                type: string
            image_keywords:
                description: "Image keywords for metadata"
                required: false
                type: string
                default: "bootc,ublue,universal-blue,kde"

env:
    IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"
    DEFAULT_TAG: "stable"
    IMAGE_LOGO_URL: "https://avatars.githubusercontent.com/u/120078124?s=200&v=4"

jobs:
    build_push:
        name: Build and push ${{ inputs.image_name }}
        runs-on: ubuntu-24.04

        permissions:
            contents: read
            packages: write
            id-token: write

        steps:
            - name: Prepare environment
              run: |
                  echo "IMAGE_REGISTRY=${IMAGE_REGISTRY,,}" >> ${GITHUB_ENV}
                  echo "IMAGE_NAME=${{ inputs.image_name }}" >> ${GITHUB_ENV}
                  echo "IMAGE_FLAVOR=${{ inputs.image_flavor }}" >> ${GITHUB_ENV}
                  echo "IMAGE_DESC=${{ inputs.image_desc }}" >> ${GITHUB_ENV}
                  echo "IMAGE_KEYWORDS=${{ inputs.image_keywords }}" >> ${GITHUB_ENV}

            - name: Checkout
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Mount BTRFS for podman storage
              id: container-storage-action
              uses: ublue-os/container-storage-action@911baca08baf30c8654933e9e9723cb399892140 # main
              continue-on-error: true
              with:
                  target-dir: /var/lib/containers
                  mount-opts: compress-force=zstd:2

            - name: Get current date
              id: date
              run: |
                  echo "date=$(date -u +%Y\-%m\-%d\T%H\:%M\:%S\Z)" >> $GITHUB_OUTPUT

            - name: Image Metadata
              uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
              id: metadata
              with:
                  tags: |
                      type=raw,value=${{ env.DEFAULT_TAG }}
                      type=raw,value=${{ env.DEFAULT_TAG }}.{{date 'YYYYMMDD'}}
                      type=raw,value={{date 'YYYYMMDD'}}
                      type=sha,enable=${{ github.event_name == 'pull_request' }}
                      type=ref,event=pr
                  labels: |
                      io.artifacthub.package.readme-url=https://raw.githubusercontent.com/${{ github.repository_owner }}/kyanite/${{ github.sha }}/README.md
                      org.opencontainers.image.created=${{ steps.date.outputs.date }}
                      org.opencontainers.image.description=${{ env.IMAGE_DESC }}
                      org.opencontainers.image.documentation=https://raw.githubusercontent.com/${{ github.repository_owner }}/kyanite/${{ github.sha }}/README.md
                      org.opencontainers.image.source=https://github.com/${{ github.repository_owner }}/kyanite/blob/${{ github.sha }}/Containerfile
                      org.opencontainers.image.title=${{ env.IMAGE_NAME }}
                      org.opencontainers.image.url=https://github.com/${{ github.repository_owner }}/kyanite/tree/${{ github.sha }}
                      org.opencontainers.image.vendor=${{ github.repository_owner }}
                      org.opencontainers.image.version=${{ env.DEFAULT_TAG }}.{{date 'YYYYMMDD'}}
                      io.artifacthub.package.deprecated=false
                      io.artifacthub.package.keywords=${{ env.IMAGE_KEYWORDS }}
                      io.artifacthub.package.license=Apache-2.0
                      io.artifacthub.package.logo-url=${{ env.IMAGE_LOGO_URL }}
                      io.artifacthub.package.prerelease=false
                      containers.bootc=1
                  sep-tags: " "
                  sep-annotations: " "

            - name: Build Image
              id: build_image
              uses: redhat-actions/buildah-build@7a95fa7ee0f02d552a32753e7414641a04307056 # v2
              with:
                  containerfiles: |
                      ./Containerfile
                  image: ${{ env.IMAGE_NAME }}
                  tags: ${{ env.DEFAULT_TAG }}
                  labels: ${{ steps.metadata.outputs.labels }}
                  oci: false
                  build-args: |
                      IMAGE_NAME=${{ env.IMAGE_NAME }}
                      IMAGE_FLAVOR=${{ env.IMAGE_FLAVOR }}

            - name: Tag for registry
              run: |
                  for tag in ${{ steps.metadata.outputs.tags }}; do
                    podman tag ${{ env.IMAGE_NAME }}:${{ env.DEFAULT_TAG }} ${{ env.IMAGE_NAME }}:$tag
                  done

            - name: Login to GitHub Container Registry
              uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
              if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Push To GHCR
              uses: redhat-actions/push-to-registry@5ed88d269cf581ea9ef6dd6806d01562096bee9c # v2
              if: github.event_name != 'pull_request' && github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
              id: push
              env:
                  REGISTRY_USER: ${{ github.actor }}
                  REGISTRY_PASSWORD: ${{ github.token }}
              with:
                  registry: ${{ env.IMAGE_REGISTRY }}
                  image: ${{ env.IMAGE_NAME }}
                  tags: ${{ steps.metadata.outputs.tags }}
                  username: ${{ env.REGISTRY_USER }}
                  password: ${{ env.REGISTRY_PASSWORD }}
